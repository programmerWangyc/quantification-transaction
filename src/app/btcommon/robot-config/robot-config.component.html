<nz-alert *ngIf="warningMessage | async as msg;" [nzMessage]="message" nzType="warning" nzCloseable nzShowIcon>
    <ng-template #message>
        <span [innerHTML]="msg"></span>
    </ng-template>
</nz-alert>

<nz-card [nzTitle]="'MODIFY_CONFIG' | translate" [nzExtra]="extra">

    <form nz-form [formGroup]="configForm" [nzLayout]="'horizontal'" fxLayout="row">
        <div class="configLeft">

            <nz-form-item>
                <nz-form-label [nzSpan]="7">{{'ROBOT_NAME' | translate}}</nz-form-label>
                <nz-form-control [nzSpan]="16">
                    <input formControlName="robotName" required nz-input>
                    <nz-form-explain *ngIf="robotName.invalid && (robotName.dirty || robotName.touched)">
                        <div *ngIf="robotName.errors.required">{{'ROBOT_NAME_REQUIRED' | translate}}</div>
                    </nz-form-explain>
                </nz-form-control>
            </nz-form-item>

            <nz-form-item>
                <nz-form-label [nzSpan]="7">{{'K_LINE_PERIOD' | translate}}</nz-form-label>
                <nz-form-control [nzSpan]="16">
                    <nz-select formControlName="kLinePeriod" [nzSize]="size" required>
                        <nz-option *ngFor="let item of periods" [nzLabel]="item.period | translate" [nzValue]="item.id"></nz-option>
                    </nz-select>
                </nz-form-control>
            </nz-form-item>

            <nz-form-item>
                <nz-form-label [nzSpan]="7">{{'MANDATORY' | translate}}</nz-form-label>
                <nz-form-control [nzSpan]="16">
                    <nz-select formControlName="agent" [nzPlaceHolder]="'PLEASE_SELECT_AGENT' | translate" *ngIf="agents | async; let agt" [ngModel]="agt[0]?.id">
                        <nz-option *ngFor="let item of agt" [nzLabel]="item | btNodeName" [nzValue]="item.id">
                            <ng-template #nzOptionTemplate>
                                <b *ngIf="item.public === 1">{{'PUBLIC' | translate}}</b>
                                <b *ngIf="item.public === 0">{{'PRIVATE' | translate}}</b>
                                {{item | btNodeName}}
                            </ng-template>
                        </nz-option>
                    </nz-select>
                </nz-form-control>
            </nz-form-item>

        </div>


        <div class="configRight">

            <nz-form-item>
                <nz-form-label [nzSpan]="6">{{'EXCHANGE_PLATFORM' | translate}}</nz-form-label>
                <nz-form-control [nzSpan]="16">
                    <nz-select formControlName="platform" [nzPlaceHolder]="'PLEASE_SELECT_PLATFORM' | translate" [nzSize]="size" [nzSpan]="6" nzShowSearch
                        [ngModel]="platforms[0]?.id">
                        <nz-option *ngFor="let item of platforms" [nzLabel]="item.label" [nzValue]="item.id"></nz-option>
                    </nz-select>
                    <nz-form-explain *ngIf="platform.invalid && (platform.dirty || platform.touched)">
                        <div *ngIf="platform.errors.required">{{'PLEASE_SELECT_PLATFORM' | translate}}</div>
                    </nz-form-explain>
                </nz-form-control>
            </nz-form-item>

            <nz-form-item>
                <nz-form-label [nzSpan]="6">{{'EXCHANGE_NAME' | translate}}</nz-form-label>
                <nz-form-control [nzSpan]="16" class="stock">
                    <nz-input-group nzCompact [nzSize]="size">
                        <nz-select [(ngModel)]="isCustomStock" [nzSize]="size" [ngModelOptions]="{standalone: true}">
                            <nz-option [nzLabel]="'CUSTOM' | translate" [nzValue]="true"></nz-option>
                            <nz-option [nzLabel]="'USE_EXIST' | translate" [nzValue]="false"></nz-option>
                        </nz-select>
                        <nz-select *ngIf="!isCustomStock" formControlName="stock" [nzPlaceHolder]="'PLEASE_SELECT_PAIR_NAME' | translate" [nzSize]="size"
                            [nzDisabled]="!platform.value">
                            <nz-option *ngFor="let item of (selectedPlatform | async)?.stocks" [nzLabel]="item" [nzValue]="item"></nz-option>
                        </nz-select>
                        <input *ngIf="isCustomStock" formControlName="stock" [nzSize]="size" [disabled]="!platform.value" nz-input>
                    </nz-input-group>
                </nz-form-control>
            </nz-form-item>

            <nz-form-item>
                <nz-form-label [nzSpan]="6">
                    <button nz-button (click)="addPair(platform.value, stock.value)">{{'ADD_EXCHANGE_PAIR' | translate}}</button>
                </nz-form-label>
            </nz-form-item>
        </div>
    </form>

    <div id="exchange-pair" fxLayout="row wrap" fxLayoutAlign="start center">
        <p *ngFor="let item of selectedPairs index as idx;" class="pairs">
            {{item.platformName}} / {{item.stock}}
            <i class="anticon anticon-close" (click)="removePair(idx);"></i>
        </p>
    </div>

    <app-robot-arg *ngIf="hasStrategyArg | async" [args]="strategyArgs | async" (change)="argChange($event)" [title]="'STRATEGY_ARGUMENTS' | translate"></app-robot-arg>

    <app-robot-arg *ngFor="let template of templateArgs | async" [title]="template.name" [args]="template.variables" (change)="argChange($event, template.name)"></app-robot-arg>

    <button nz-button [nzType]="'primary'" type="submit" (click)="modify$.next(configForm.value)" [disabled]="configForm.invalid || !selectedPairs.length">
        {{'UPDATE_CONFIG' | translate}}
    </button>

    <button nz-button *ngIf="hasArgs | async" [nzType]="'primary'" (click)="exportArgs()">
        <i class="anticon anticon-upload"></i>
        <span>{{'EXPORT_ARGUMENT' | translate}}</span>
    </button>

    <button nz-button *ngIf="hasArgs | async" class="file-btn">
        <i class="anticon anticon-download"></i>
        <span>{{'IMPORT_ARGUMENT' | translate}}</span>
        <input type='file' ng2FileSelect [uploader]="uploader" (onFileSelected)="importArgs($event)">
    </button>

</nz-card>

<ng-template #extra>
    <a (click)="toggleFold()">
        {{(isFold ? 'UNFOLD' : 'FOLD') | translate}}
    </a>
</ng-template>
